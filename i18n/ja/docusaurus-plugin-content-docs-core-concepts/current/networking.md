---
sidebar_position: 4
---

# Hydraネットワーキング

このドキュメントでは、HydraNetworkingLayerについて詳しく説明します。ヘッドを開くことができるHydraノードで構成されるネットワーク。

:::warning

🛠 このドキュメントは進行中の作業です。ネットワーキングの現在の状況は理想的とは言えません。これは、開始して機能するものを用意するための方法にすぎません。ネットワークをより動的にすることによって状況を改善する[提案](https://github.com/input-output-hk/hydra-poc/pull/237)があります。
:::

# 質問

* トランスポート層のトポロジーはどのようなものが想定されますか？
  * 接続されたピアは、ヘッドパーティのサブセット/スーパーセット/アイデンティティセットですか？
* TCPが提供する配信順序と信頼性の保証は必要ですか？
  * TCPは、ノード間の全二重ストリーム指向の持続的接続です。
  * 私たちのネットワーク層は、UDPに適していると思われる非同期メッセージパッシングに基づいています
* ノードがファイアウォールを介して到達可能であることに注意する必要がありますか？
  * Hydraノードのニーズに合わせてファイアウォールやNATを設定する責任をエンドユーザーに負わせることができます。
  * エンドユーザーよりも、企業・法人・団体のプレーヤーが使いやすいかもしれません。
* Headにプライバシーは必要ですか？
  * Txの詳細は外部のオブザーバーには不透明であり、Headのファンアウトの最終結果のみが観察可能であるべきです
* ピア/パーティをどのように知る/発見しますか？
  * この論文では、以下のような_Setup_フェーズが存在することを仮定しています。
    > Head-Protocolインスタンスを生成するために、イニシエータは参加者のリスト、使用する（多重）署名スキームのパラメータなどのプロトコルパラメータを発表して、参加者のセット${p1,...,pn}$（自分がその一人である）を招待する。
    > その後、各パーティは他のすべてのパーティとペア認証されたチャネルを確立します。
  * 参加者のリストは正確には何ですか？少なくとも、お互いを区別するために、各参加者を特定する必要があるようですが、どのようにしたらよいでしょうか。いくつかの命名スキーム？IP：ポートアドレス？公開鍵？証明書？
  * 「ペアワイズ認証チャネル」とは正確には何ですか？これらは実際のTCP/TLS接続ですか？それとも、レイヤー4（トランスポート）またはレイヤー5（セッション）ソリューションですか？
* ネットワークプロトコルをどの程度オープンにしたいですか？
  * 現在、メッセージのCBORエンコーディングでOuroborosスタックを使用しています。これにより、他のツールをHydraネットワークに含めることがやや困難になります。

# 調査

## Ouroboros

2022-02-14にネットワークチームとミーティングを行い、OuroborosネットワークスタックがHydraにどのように適合するかを調査しました。  
Neil Daviesがいくつかの興味深い数字を挙げて、議論はすぐにパフォーマンスに基づいて導き出されました。

* 世界一周: 600ms
* 1大陸での遅延: 50-100ms
* データセンターでの遅延: 2-3ms
* ノードが配置されている場所では、1秒未満のラウンドトリップで問題ありません。
* TCP接続の基本的な信頼性は距離とともに低下します:
   * DC内接続は永続的に持続可能
   * DC外接続: TCPのCnxを永遠に稼働させ続けることは難しく、中間ノードがダウンして経路が変更された場合、経路の再設定に90秒かかります。
   * れは、接続数が増えると、常に少なくとも1つの接続がダウンする可能性が高くなることを意味します。
* ヘッドを閉じるには、ネットワーク接続から切り離す必要があります=>TCPcnxが消える=/=>ヘッドを閉じる
* カルダノネットワーク内では、単一の空のブロックの伝播には400msかかります（10Kノードに到達するため）
     * ouroborosネットワークは数千の接続に耐える必要があります（システムレベルの制限がいくつかあります）
* Hydraネットワークのモデリング
   * ネットワークの性能をモデル化するための論理的枠組み CDFとメッセージが全ノードに現れるまでの時間を関連付ける（これは[hydra-sim](https://github.com/input-output-hk/hydra-sim)で行われていることです。
   * 例えば、Snocket = PTP connection with ordered guaranteed messages delivery のような、我々が期待するセマンティクスを持つレイヤーを定義することができます。Hydraにそれが必要でしょうか？
* [ワイヤーガード](https://wireguard.io)はいかがでしょうか。欠点もありますが、とても面白いアプローチです。
    * グローバルアドレス指定なし
    * 1つのethインターフェース/接続があります
    * プラス面として、IPアドレスの変更を透過的に管理します
    * ファイアウォールに対応しないため、各ノードでNATを設定する必要があります。

## カルダノネットワーク

カルダノネットワークの仕組みやウロボロスの使い方についての詳しい注意点は、[このWikiページ](https://github.com/input-output-hk/hydra-poc.wiki/blob/master/Networking.md#L1)をご覧ください。

* Cardanoは、数千のノードにまたがるグローバルネットワークであり、ノードの出入りとトポロジは大きく異なります。その主な目的はブロックの伝播です。コンセンサスルールに従って一部のノードによって生成されたブロックは、20秒未満でネットワーク内のすべてのノードに到達する必要があります。
* ノードは他のすべてのノードに接続することはできないため、ブロックの拡散は、ブロック交換を行う限られたピアのセットに接続する、何らかの形のゴシップ_によって行われます。
* ノードはピアや他のノードからの敵対的な振る舞いに耐性を持つ必要があり、そのため取り込みたいデータの量と速度を制御する必要があり、そのため「プルベース」のメッセージングレイヤーが必要となります。
* プロデューサー・ノードは署名鍵にアクセスする必要があるため、安全性を高め、DoSやその他の悪意のある行為のリスクを減らすために、通常、リレー・ノードの後ろで実行されます。
* ノードはADSLやケーブルボックス、ファイヤーウォールなどの背後にあり、ノードを直接アドレス指定できないような複雑なネットワーク環境で動作することが想定されるため、ノードが外部から到達可能なリレーノードへの接続を「開始」し、「プルベース」のメッセージングが必要になります。

# 導入事例

## 現在の状態

* Hydraのノードは、Point-to-point(例えばTCP)接続を使用してペア接続されたピアネットワークを形成します。これらの接続は、常に稼働していることが期待されます。
  * ノードは基盤となるネットワーク抽象化として[Ouroboros](https://github.com/input-output-hk/ouroboros-network/)を使用します。これは、`Snocket`と呼ばれる信頼性の高いポイント・ツー・ポイントのストリームベースの通信抽象化により、ピアとの接続を管理することを担います。
  * すべてのメッセージは、PTP接続を使用してピアにブロードキャストされます
  * Hydraプロトコルの性質上、ピアとの接続がないため、Headの進行が妨げられます。
* `hydra-node`すべてのピアとの間でしかヘッドを開くことができません。これは、ノードは事前に開きたいピアとヘッドのトポロジーを知っておく必要があることを意味します。
* 接続されたノードは、ハートビートと交換されたメッセージの監視を通じて基本的な障害検出を実装します

## ゴシップ拡散ネットワーク

次の図は、IOGのネットワーキングエンジニアとの話し合いから得られた、Hydraのプルベースのメッセージングシステムの1つの可能な実装です。

![Hydra pull-based network](./hydra-pull-based-network.jpg)
